\documentclass[11pt,a4paper]{article}   

\usepackage[margin=1.0in]{geometry}

\usepackage{graphicx}
\graphicspath{ {./figures/} }
\usepackage{floatrow}
\usepackage{subfig}

\usepackage{amsmath}
\usepackage{comment}

\newcommand\RE{\operatorname{Re}} 
\newcommand\IM{\operatorname{Im}} 
\newcommand\Tr{\operatorname{Tr}} 

\newcommand\MSbar{$\overline{\text{MS}}$ } % MS-bar 
\newcommand\he[1]{#1^\dagger}% Hermitian conjugate
\newcommand\gr[1]{\mathrm{#1}}% font for group names such as SU(2)


\usepackage{color}
\definecolor{myorange}{rgb}{1,0.5,0}
\newcommand\lauri[1]{{\color{myorange}#1}}

\title{Documentation for lattice simulations}
\author{Lauri Niemi}
\date{\today}

\begin{document}
\maketitle


\section{Multicanonical algorithm}

In a first-order phase transition, mixed-phase configurations are exponentially suppressed by a factor proportional to the volume, $p \sim e^{-V}$. Thus, for large lattices it becomes necessary to enhance tunneling probability in order to study phase transitions. For this we use the multicanonical method \cite{Berg:1991cf}: our action is modified by a weight function $W(R)$, where $R$ is a suitable order parameter that distinguishes all relevant phases. We choose sign convention $S' = S_\text{canonical} + W(R)$, so that weight \textit{increases} when a certain configuration is to be suppressed and the ideal weight function is just the canonical probability distribution for $R$. Once we obtain a multicanonical distribution from a simulation, the canonical distribution is obtained simply by reweighting. Remember, however, that the simulation is formally correct with any $W$, as reweighting "removes" the weight in the end. \textbf{In the measurement file, we measure $-W(R)$ instead of $W(R)$ to ensure compability with Kari.}

In practice the weight function is implemented by specifying a range $R_\text{min} \leq R \leq R_\text{max}$ that we want to enhance with multicanonical, and dividing this range into bins of equal length so that the system is in bin $i$ when $R_{i} \leq R < R_{i+1}$, and $R_0 = R_\text{min}$. Inside bin $i$, we approximate $W$ by a linear interpolation. Denoting $W(R_i) = w_i$, for $R_{i} \leq R < R_{i+1}$ we have 
\begin{align}
W(R) = w_i + (R - R_i) \frac{w_{i+1} - w_i}{R_{i+1} - R_i},
\end{align}
and in the last bin we simply use constant weight. Outside the binning range the weight is chosen to be constant and equal to $w_i$ in the nearest bin.

Since the weight function generally depends on a \textit{global} parameter $R$ (ex. volume average of $\phi^\dagger\phi$), parallelization of multicanonical algorithms is not straightforward. We use the following method, adapted from Kari: 

\begin{itemize}
	
	\item Perform an even-odd sweep on the lattice, updating half of the sites locally using \textit{canonical} updates such as standard overrelaxation. This moves the system towards a local minimum of the canonical ensemble. For example if the order parameter is $\phi^\dagger\phi$, we update the Higgs field at half of the sites but do not touch the other fields yet.
	
	\item After the sweep, recalculate the order parameter and perform an accept/reject step based on the change in the weight function. The sweep of updates is accepted with probability $\min(1, \exp[W(R) - W(R') ])$, where $R$ and $R'$ are the old and new values the order parameter. If rejected, ALL local updates contributing to the weight change are undone (ex. if $R$ is the Higgs hopping term, we sweep and update gauge links and the Higgs, and then apply the multicanonical step. If rejected, undo changes in both Higgs and the links). This step produces a bias towards mixed-phase configurations where the weight function is smaller. 
	
\end{itemize}

For the "easy" order parameter $\phi^\dagger\phi$, the acceptance rate of the multicanonical update is generally good, $>90\%$. This is in agreement with Kari's acceptance rates in the SM and MSSM. \textbf{To do:} optimize the algorithm for more complicated order parameters. It should be safe to do perform the multicanonical step in parts, so that if we choose hopping term as the order parameter, we can first update half of the links, do global acc/rej, then update half of the Higgs and do acc/rej again etc.

\subsection{Calculation of the weight function}

Since the canonical probability distribution (and the weight) is not known \textit{a priori}, we need an algorithm for approximating the weight function. For our purposes there are (at least) two good options for automatizing this process: 
\begin{itemize}
	
	\item Recursive computation of Berg. The detailed recipe for performing (a variation of) this algorithm has been described in \cite{Laine:1998qk} (small detail: weight in the first bin can be set arbitrary, because weights in all other bins are calculated relative to it). This method is very general and will eventually converge to the correct weight function, but is somewhat complicated and can be hard to implement well. \textbf{We will not use this.}
	
	\item The Landau-Wang method. We use a variation of this, basically copied from Kari's old lecture notes (he also uses it in his current SUSY code). 
	
\end{itemize}

Details of our algorithm are as follows:

\begin{itemize}
	
	\item Perform a short Monte Carlo run with fixed weight, using the multicanonical update outlined above. After each multicanonical acceptance step (even if rejected!), measure the order parameter and check which bin the system is in. Unless the order parameter is outside the binning range, increase w.hits[bin] by one. 
	
	\item After $M$ ($\sim 500-2000$) such measurements, update weight function in each bin by factor w.hits[bin]$\times \delta / n_\text{bins}$, where $\delta$  is an increment factor and $n_\text{bins}$ is the total number of bins (the normalization is very convenient and generally leads to smoother weight functions). After updating, reset w.hits and repeat the measurements.
	
	\item Initially when the weight is flat, canonical configurations are preferred and so weight is increased in the pure phases by large amounts. To make the weight function converge, the increment factor $\delta$ needs to be gradually decreased so that weight of mixed-phase configurations does not catch up to the pure phases. Again we adapt Kari's method here: each time the system tunnels from the last bin to the first bin (or vice versa), set $\delta \leftarrow \delta / 1.5$. This check is only performed after a full set of multicanonical measurements (after updating the weight). This method generally works well if the mixed-phase suppression is strong. 
	
\end{itemize}


\begin{figure}[h]
\centering
	\includegraphics[scale=0.5]{weight}
	\caption{Sample weight function produced using the above algorithm. This corresponds to the SM case with $m_H^* = 35$ GeV, $\beta_G = 8$ and $V = 10\times 10\times 30$. Horizontal axis is the multicanonical order parameter $\langle\frac12 \Tr\Phi^\dagger\Phi\rangle$. }
	\label{fig:weight}
\end{figure}

\begin{figure}[H]
	\centering
	\subfloat{\includegraphics[width=0.7\textwidth, height=6.5cm]{nomulti}\label{}} \\
	\vspace{-0.25cm}
	\subfloat{\includegraphics[width=0.7\textwidth, height=6.5cm]{multi}\label{}}
	\caption{Time histories for the observable $\langle\frac12 \Tr\Phi^\dagger\Phi\rangle$, top: no multicanonical weight, bottom: using the weight in Fig.~\ref{fig:weight}. Without the weight function, the system is stuck in the pure phases and only rarely samples the mixed-phase configurations. Here the volume is still quite small; already for a slightly larger volume \textbf{I could not get the system to tunnel even once without multicanonical weighting.}} 
\end{figure}


A possible downside of this method is that it may not be possible to produce a completely smooth weight function if the $\delta$ parameter becomes small too quickly. Usually this does not matter however, because the resulting "spikes" remain quite small. A good initial value for $\delta$ is $\sim 0.5$ and number of bins $\sim 100$. Binning range should be chosen so that both spikes are included and preferably some extra, but not regions that are already very strongly suppressed (need to be especially careful with the symmetric phase peak, which is usually very sharp).


\section{Lattice actions and parametrization}


By default, the code assumes that all physical input parameters and fields are in natural lattice units, i.e. scaled dimensionless by the lattice spacing $a$. Here we describe the procedure for converting the continuum parameters into input parameters for the code for some implemented models. 


\subsection{SU(2) + fundamental Higgs}


This is simply the dimensionally reduced Standard Model with $\gr{U(1)}$ hypercharge neglected. Simulations are to be compared to results of Ref.~\cite{Kajantie:1995kf}. Our 3d continuum Lagrangian (with couplings chosen to be dimensionful, so that the action $S = \int d^3x \mathcal{L}$) is 
\begin{align}
\mathcal{L} = \frac14 (F^a_{ij})^2 + (D_i \phi)^\dagger (D_i \phi) + \mu^2_\phi \phi^\dagger\phi + \lambda (\phi^\dagger\phi)^2.
\end{align}
Everything here is in terms of 3d parameters, hence no subscript. On the lattice, it is convenient to parametrize the doublet using the Pauli matrices $\sigma_j$; this simplifies many update algorithms. If the vector $\phi = \frac{1}{\sqrt{2}}(H_1, H_2)^T$, the matrix field is obtained as 
\begin{align}
\label{eq:Higgs-matrix}
\Phi = \frac{1}{\sqrt{2}}\begin{pmatrix}
H_2^* & H_1 \\
-H_1^* & H_2
\end{pmatrix} \equiv \frac{1}{\sqrt{2}} (h_0 \sigma_0 + i h_k \sigma_k), 
\end{align}
and the code uses the RHS components $h_0, h_k$. They are related to the vector components as 
\begin{align}
h_0 = \RE H_2, \quad h_1 = \IM H_1, \quad h_2 = \RE H_1. \quad h_3 = -\IM H_2.
\end{align}
This can be checked by comparing hopping terms in the two parametrizations as the ordering does make a difference. Note that $\frac12 \Tr \he\Phi\Phi = \he\phi\phi = \frac12 \phi_\mu \phi_\mu$. \lauri{In David's code, the components are ordered differently as the vector notation is preferred, leading to a seemingly different implementation of the hopping term.}




The discretized action reads ($i,j$ denote directions)
\begin{align}
\label{eq:action_higgs}
S_\text{latt} =& \beta_G \sum_{\textbf{x}, i<j} \Big(1-\frac12 P_{ij}(x)\Big) \nonumber \\ 
 &+2 \sum_{\textbf{x},i} \Big( a \frac12  \Tr \he\Phi(x)\Phi(x) - a \frac12 \RE \Tr \he\Phi(x) U_i(x)\Phi(x+i) \Big) \nonumber \\
& + \sum_\textbf{x} \bigg( a^2 m_\phi^2 \frac12 a \Tr \he\Phi\Phi + a \lambda \left[\frac12 a \Tr \he\Phi\Phi\right]^2\bigg),
\end{align}
where $U_i$ is a $\gr{SU(2)}$ link matrix in direction $i$, related to the gauge field $A_i^a$ as 
\begin{align}
U_i(x) = \exp \left[\frac12 i g \sigma_a A_i^a(x) \right], 
\end{align}
and $P_{ij}(x) = \RE \Tr U_i(x) U_j(x+i) \he U_i(x+j) \he U_j(x)$. In the code, we write the link as 
\begin{align}
U_i = u_0 \sigma_0 + i u_k \sigma_k.
\end{align}
Note the different normalization compared to the doublet. The condition $\det U = 1$ is required for $U$ to be an $\gr{SU(2)}$ matrix; otherwise it is an $U(2)$ matrix. For $\gr{SU(2)}$, all traces here are automatically real.

The code operates with the dimensionless object $\frac12 a \Tr \he\Phi\Phi$ etc, and takes as inputs the combinations $m^2_\text{lat} \equiv a^2 m^2_\phi, \lambda_\text{lat} \equiv a \lambda$ and 
\begin{align}
\beta_G = \frac{4}{a g^2},
\end{align}
with $\beta_G$ essentially used to fix the lattice spacing. The lattice parameters need to be matched onto parameters in continuum renormalization (usually \MSbar) by comparing divergences at two loops (c.f. Ref.~\cite{Laine:1995np}). Formulas for converting continuum parameters into inputs for the code are listed in Appendix~\ref{sec:lat-cont}.


\subsubsection{Notes on multiple Higgs doublets}

Suppose we have two doublets $\phi_1, \phi_2$. There are four independent bilinears: $\phi_{ij} = \he\phi_i\phi_j$, and the potential used in code is 
\begin{align}
V(\phi_1, \phi_2) =& m_1^2 \phi_{11} + m_2^2 \phi_{22} + \frac12 (m_{12}^2 \phi_{12} + h.c.) + \lambda_1 \phi_{11}^2 + \lambda_2 \phi_{22}^2 + \lambda_3 \phi_{11}\phi_{22} + \lambda_4 \phi_{12}\phi_{21} \nonumber \\
& + \frac12 (\lambda_5 \phi_{12}^2 + \lambda_6 \phi_{11}\phi_{12} + \lambda_7 \phi_{22}\phi_{21} + h.c.).
\end{align}
\lauri{(note: factor of $1/2$ in all complex terms!!)} 

In terms of matrices $\Phi_1, \Phi_2$ defined as in eq.~(\ref{eq:Higgs-matrix}), we have 
\begin{align}
\phi_{ii} = \frac12 \Tr \he\Phi_i\Phi_i, \quad R \equiv \RE \phi_{12} = \frac12 \Tr \he\Phi_1\Phi_2, \quad I \equiv \IM \phi_{12} = - i\frac12 \Tr \Phi_1 \sigma_3 \he\Phi_2
\end{align}
and the potential can be written as 
\begin{align}
V =& m_1^2 \phi_{11} + m_2^2 \phi_{22} + \RE m_{12}^2 R - \IM m_{12}^2 I + \lambda_1 \phi_{11}^2 + \lambda_2 \phi_{22}^2 + \lambda_3 \phi_{11}\phi_{22} + \lambda_4 (R^2 + I^2)\nonumber \\
& + \RE \lambda_5 (R^2 - I^2) - 2\IM \lambda_5 RI + \phi_{11} (\RE\lambda_6 R - \IM\lambda_6 I) +  \phi_{22} (\RE \lambda_7 R + \IM \lambda_7 I),
\end{align}
which is easy to program in.


\subsection{SU(2) + adjoint scalar (real triplet)}

This is essentially a dimensionally reduced QCD with two colors (see Ref.~\cite{Kajantie:1997tt}). The adjoint scalar is defined as $\Sigma = \frac12 \Sigma^a \sigma_a$ (3 components) and the 3d continuum Lagrangian is 
\begin{align}
\mathcal{L} = \frac14 (F^a_{ij})^2 + \frac12 (D_i \Sigma^a)^2 + \frac12 \mu^2_\Sigma \Sigma^a\Sigma^a + \frac14 b_4 (\Sigma^a\Sigma^a)^2.
\end{align}
Again, we prefer to write the lattice action using the matrix $\Sigma$, keeping in mind that $\Tr \Sigma^2 = \frac12 \Sigma^a \Sigma^a$. It reads
\begin{align}
\label{eq:action_adjoint}
S_\text{latt} =& \beta_G \sum_{\textbf{x}, i<j} \Big(1-\frac12 P_{ij}(x)\Big) + 2\sum_{\textbf{x},i} \Big( a \Tr\Sigma(x)^2 - a \Tr\Sigma(x)U_i(x)\Sigma(x+i)\he U_i(x) \Big) \nonumber \\
& + \sum_\textbf{x} \bigg[ (a m_\Sigma)^2 (a \Tr \Sigma^2) + a b_4 (a \Tr \Sigma^2)^2\bigg],
\end{align}

This is exactly the same action as in Ref.~\cite{Kajantie:1997tt}, but they denote $\Sigma = A_0, m_\Sigma = m_D, b_4 = \lambda_A$.

\subsection{SU(2) + fundamental Higgs + adjoint scalar}

The full continuum Lagrangian in 3d is 
\begin{align}
\mathcal{L} =& \frac14 (F^a_{ij})^2 + (D_i \phi)^\dagger (D_i \phi) + \mu^2_\phi \phi^\dagger\phi + \lambda (\phi^\dagger\phi)^2 \nonumber \\ 
& + \frac12 (D_i \Sigma^a)^2 + \frac12 \mu^2_\Sigma \Sigma^a\Sigma^a + \frac14 b_4 (\Sigma^a\Sigma^a)^2 +\frac12 a_2 \phi^\dagger\phi \Sigma^a\Sigma^a,
\end{align}
and the lattice action is simply a combination of Eqs.~(\ref{eq:action_higgs}) and (\ref{eq:action_adjoint}) with the additional interaction term
\begin{align}
S_{a_2} = \sum_\textbf{x} (a a_2) \frac12 \Tr (a\he\Phi\Phi) \Tr (a\Sigma^2). 
\end{align}


\subsection{Adding the $\gr{U(1)_Y}$ subgroup}

Simulations in the electroweak $\gr{SU(2) \times U(1)}$ effective theory in 3d were discussed in \cite{Kajantie:1996qd}. Including the $\gr{U(1)}$ gauge field to the actions above is straightforward. 

The link variable is just the complex number $u_i(x) = \exp(i g' B_i(x)) \equiv \exp(i \alpha_i(x))$, where $B_i = a (B_i)_\text{cont}$ is the associated gauge field in the $\gr{U(1)}$ algebra; the simulation will operate on the real numbers $\alpha_i(x)$ (in code: u1field[x][dir]). The plaquette trace for $\gr{U(1)}$ can be written as 
\begin{align}
p_{ij}(x) = \exp\{i[\alpha_i(x) + \alpha_j(x+i) - \alpha_i(x+j) - \alpha_j(x)]\}.
\end{align}
Taking the real part, we obtain the Wilson action as 
\begin{align}
S_\gr{U(1)} = \beta_G' \sum_{x, i<j} \Big[ 1 - \frac12 \Big(p_{ij}^{1/\gamma} + (p_{ij}^*)^{1/\gamma}\Big)\Big] 
\end{align}
where $\gamma > 0$ is an arbitrary parameter that can be adjusted to reduce finite-size effects. Note that all values of $\gamma$ should give the same continuum limit, but to get proper representations of the $\gr{U(1)}$ group one has to choose  $\gamma = 1, 1/2, 1/3, \dots$ \lauri{(understand this!!)}. I use $\gamma = 1$ because then the above action is very simple to implement in the code. We denote 
\begin{align}
\beta_G' = \frac{1}{a {g'}^2},
\end{align}
which guarantees the correct continuum limit.


The Higgs covariant derivative in continuum is taken to be 
\begin{align}
D_i \phi = \partial_i \phi + \frac12 i g A^a_i \sigma_a + Y i g' B_i 
\end{align}
and I use normalization $Y = 1/2$.
The Higgs doublet $\Phi$, in matrix parametrization, transforms under a $\gr{SU(2) \times U(1)}$ gauge transformation as 
\begin{align}
\Phi(x) \rightarrow G(x) \Phi(x) e^{-i Y \alpha(x)\sigma_3},
\end{align}
where $\sigma_3$ is the third Pauli matrix (to check that this is the correct transformation rule, apply $\phi \rightarrow e^{i Y \alpha} G(x) \phi$ on the vector $\phi$ and see how the elements of $\Phi$ transform). 

The only change to the scalar sector is in the hopping terms, modifying update algorithms for the Higgs and also the $\gr{SU(2)}$ links. The Higgs covariant derivative becomes 
\begin{align}
\sum_{x, i} \Big[ \Tr \he\Phi(x)\Phi(x) - \RE\Tr \he\Phi(x)U_i(x)\Phi(x+i)e^{-i Y \alpha_i(x)\sigma_3}\Big].
\end{align}
To calculate this, it is often convenient to write 
\begin{align}
e^{-i Y \alpha\sigma_3} = \sigma_0\cos( Y \alpha) - i \sigma_3 \sin(Y \alpha),
\end{align}
with $\sigma_0$ again being the $2\times 2$ identity matrix. The choice of $\gamma$ does not affect the Higgs hopping term. Note that this trace is still real.
\lauri{Note:} I could of course rescale the $\alpha_\mu$ variables so that effectively $Y=1$ in the above. But then the relation to continuum $B_\mu$ would be different, so $\beta_G'$ would be different. In the $Y=1$ normalization, $\beta_G' = 4/(a{g'}^2)$, which is what \cite{Kajantie:1996qd} uses.

\section{Local update algorithms}

In scalar theories, the common procedure for updating fields seems to be $4-5 \times $overrelaxation, followed by a Metropolis update to obtain ergodicity. Gauge fields are updated using heat bath algorithms. We adapt this procedure, and the details are given in this section. An important thing to keep in mind is the fact that for flat potentials (especially Higgs in the broken phase), substantial improvement can be obtained by optimizing the updates for radial parts of the scalar fields (e.g. $\Phi = R V$, with $R \geq 0, V \in SU(2)$). 

As a side note, we point out that the global radial update for the Higgs advertised in \cite{Kajantie:1995kf} is most likely not worth implementing, because it scales very badly with volume. \lauri{Kari also ditched it already a long time ago.}

\subsection{Overrelaxation for the scalars}

Consider first a simple overrelaxation update based on Gaussian approximation of the scalar potential. The local Higgs potential can be written as 
\begin{align}
V(\Phi(x)) = s_a \phi_a + B R^2 + C R^4,
\end{align}
where the components $\phi_a$ are as defined in Eq.~(\ref{eq:Higgsfield}), $R^2 = \frac12 \Tr\Phi^\dagger\Phi$ and $s_a$ is the hopping term staple. Neglecting the $R^4$ term for now, it is straightforward to overrelax $\phi_a$ by solving the new field components $\phi'_a$ from
\begin{align}
\phi'_a + \frac{s_a}{2B} = -(\phi_a + \frac{s_a}{2B}).
\end{align}
To account for the quartic term, we simply do an accept/reject based on the difference $C (R')^4 - C R^4$. If $C$ is small, the acceptance rate is high and the algorithm can be expected to work well. In my tests in the SM case $x=0.034$ (very small $C$) I obtained acceptance of $\sim 95\%$. \lauri{I believe Guy Moore used this update for SM nucleation.} Note that this update generalizes very simply to e.g. adjoint scalars.

We can, however, do better by adapting the overrelaxation presented in \cite{Kajantie:1995kf} (has slight error in $Y^2$ parts) and \cite{Laine:1998qk} (no error). Because the algorithm is described in detail in the aforementioned references, I will not bother writing it here. The basic idea is to perform separate updates on Cartesian parametrization of the Higgs field, which also is very efficient in updating the radial part. This update yields acceptance rate of whopping $99.8\%$ or better, and I have tested that it facilitates tunneling much more effectively than the Gaussian approximation above, at least in the SM $x = 0.034$ case. \textbf{I use this optimized update for both Higgs and the adjoint scalar}. \lauri{(slightly confusing thing here: in Kari's code he does not seem to overrelax the $Y$ component at all, or at least this is not very obvious. Perhaps updating the $X$ part really is enough in practice?)}

\subsection{$\gr{SU(2)}$ gauge link heat bath}

An efficient update for the $\gr{SU(2)}$ gauge links is the standard Kennedy-Pendleton heatbath \cite{Kennedy:1985nu}. The logic is as follows:
\begin{itemize}

	\item For a link $U_i(x)$, write the local action in the form $S[U_i(x)] = \RE \Tr U_i(x) \hat{S}$, where $\hat{S}$ is a local staple (for $\gr{SU(2)}$, the trace here is automatically real). The staple is calculated from the Wilson action, as well as from hopping terms if scalars are present. In SM, it is given by
\begin{align}
\hat{S} =& - \frac12 \beta_G \sum_{j \neq i} \Big[ U_j(x+i) U^\dagger_i(x+j) U^\dagger_j(x) \nonumber \\ 
 &+ U^\dagger_j(x+i-j) U^\dagger_i(x-j) U_j(x-j) \Big] - \Phi(x+i)e^{-i \alpha_j(x) \sigma_3}\he\Phi(x). 
\end{align} 
Note that the $\gr{U(1)}$ field does contribute to the hopping term, but the modification to code is minimal; simply write $e^{-i \alpha_j(x) \sigma_3} = \cos \alpha_j(x) \sigma_0 - i \sin\alpha_j(x) \sigma_3$ and do the multiplication with the Higgs.

	\item Normalize $\hat{S}$ to produce an $\gr{SU(2)}$ matrix: $V = -\hat{S} /k$ where $k = \sqrt{\det \hat{S}}$. Accounting for the minus sign, the distribution to be generated for $U$ is $\sim \exp[k \RE\Tr U V] dU$. Because the Haar measure stays invariant under right multiplication with $V^{-1}$, the distribution for $U V^{-1}$ is just 
\begin{align}
\sim \exp[k \RE\Tr U] dU = \exp[2 k a_0] \frac{1}{2\pi^2} \delta(a^2-1) d^4 a,
\end{align}
where we wrote $U = a_0 \sigma_0 + i a_i \sigma_i$.

	\item Now we just generate $a_0$ and $a_i$ using the recipe described in \cite{Kennedy:1985nu} to get a new $U'$, but since this new link follows the distribution of $U V^{-1}$ we need to multiply by $V^{-1} = \he V$. Thus the new link variable is $U' \he V$.

\end{itemize}


If an adjoint scalar is present, this simple recipe no longer works because the adjoint hopping term is quadratic in $U_i(x)$. Instead, we generate a new link candidate following the above recipe, and then accept it with the probability $\min[1, \exp(H - H')]$, where $H$ and $H'$ are the adjoint hopping terms before and after the link update. Acceptance rate is typically good, $>80\%$.


\section{Sample histograms and comparison to old results}


\subsection{$\gr{SU(2)} + $Higgs in 3d}

The SM case can be compared to Ref.~\cite{Kajantie:1995kf}. Note that their histograms are given in terms of $R^2$, which is related to our $\Phi$ as
\begin{align}
\label{eq:kari_fields}
R^2 = \frac{2}{\beta_H} \frac12 \text{Tr} (\Phi^\dagger\Phi)_\text{latt} = \frac{2a}{\beta_H} (\phi^\dagger\phi)_\text{cont}
\end{align}
and $\beta_H$ can be calculated from given continuum parameters via their Eqs.~(2.5)-(2.7). In their histograms they seem to give the pure lattice value for $R^2$, i.e. no divergence has been subtracted. \textbf{Our histograms are also presented in terms of the lattice fields.} Note that they parameterize their $x,y$ in terms of $T^*$ and $m^*_H$.

For the histogram in Fig.~6 of Ref.~\cite{Kajantie:1995kf} (left figure), our lattice inputs corresponding to $\beta_G=8, m^*_H = 35$ GeV, $T^* = 94.181$ GeV are
\begin{align}
\label{eq:SM-inputs}
\lambda = 0.00915047 \quad m^2_\phi = -0.207404.
\end{align}
Some histograms produced with my code using these inputs are shown in Fig.~\ref{fig:SM_hgrams}.

\lauri{Note that David's code takes in $g = 0.707107$ instead of $\beta_G$. Note also that David's conversion.py script defined $a g^2 = 2/\beta_G$ instead of the usual $a g^2 = 4/\beta_G$, and correspondingly the Wilson term was normalized differently in the code. Now that we use the standard convention, the conversion script is outdated. }


\begin{figure}[H]
	\includegraphics[scale=0.5]{hgrams_beta8_mH35}
	\caption{Histograms for the SM case with inputs as in Eq.~(\ref{eq:SM-inputs}). The smallest volume was done without multicanonical. The histograms agree well with those in Fig.~6 of Ref.~\cite{Kajantie:1995kf}, although our normalization is still off here. Their $\beta_H = 0.3450806$ here, so converting their x-axis to ours using Eq~(\ref{eq:kari_fields}) we see that the peaks are located exactly as in their figure. }
\label{fig:SM_hgrams}
\end{figure}


\begin{figure}[H]
	\includegraphics[scale=0.5]{mH-60-beta-8}
	\caption{Histogram corresponding to $m^*_H = 60$ GeV, $T^* = 137.669$ GeV, $\beta_G = 8$. Compare with Figure~5 in Ref.~\cite{Kajantie:1995kf}. Our lattice inputs here are $m_\phi^2 = -0.263633, \lambda = 0.0322228$.}
\label{fig:mH60-hgram}
\end{figure}



For the right-hand side histogram in Fig.~6 of Ref.~\cite{Kajantie:1995kf}, the inputs corresponding to $\beta_G=8, m^*_H = 70$ GeV, $T^* = 153.620$ GeV are
\begin{align}
\label{eq:SM-inputs2}
\lambda = 0.0448519 \quad m^2_\phi = -0.287506.
\end{align}
\lauri{Haven't really tested these yet because the other cases worked so well...}


\subsection{$\gr{SU(2)} + $adjoint scalar in 3d}

We can compare to histograms in Fig~4 of Ref.~\cite{Kajantie:1997tt}. In this case $\Sigma^a$ is identified as the temporal scalar $A_0^a$ originating from thermal screening of the gauge field $A^a_\mu$. They define 
\begin{align}
	y = \frac{m^2_D(g^2)}{g^4}, \quad x = \frac{\lambda_A}{g^2} = \frac{b_4}{g^2},
\end{align}
in terms of which they give their results (these are in \MSbar!). In Fig.~4 they give $x, \beta_G$ and volume for the histograms, while $y_c$ needs to be calculated from their Eq~(5.12). The lattice mass is then obtained from $y_c$ by subtracting the lattice divergence (Appendix \ref{sec:lat-cont}).

Some lattice inputs corresponding to histograms in their Fig~4 are:
\begin{align}
\label{eq:inputs-A0}
x =& 0.04, \beta_G = 32: m^2_\Sigma = -0.123686, b_4 = 0.005 \\ 
x =& 0.12, \beta_G = 8: m^2_\Sigma = -0.54502, b_4 = 0.06 \\
x =& 0.20, \beta_G = 16: m^2_\Sigma = -0.315858, b_4 = 0.05.
\end{align}   
Histograms corresponding to these are shown in Fig~\ref{fig:A0_only}. \lauri{To do: normalize these properly...}
\begin{figure}[H]
	\centering
	\subfloat[$x=0.04, V = 18^3$]{\includegraphics[width=0.33\textwidth]{A0_x-0_04}\label{}}
	\subfloat[$x=0.12, V = 12^3$]{\includegraphics[width=0.33\textwidth]{A0_x-0_12}\label{}}
	\subfloat[$x=0.20, V = 28^3$]{\includegraphics[width=0.33\textwidth]{A0_x-0_20}\label{}}
	\caption{Histograms obtained with the inputs of Eq.~(\ref{eq:inputs-A0}) (unnormalized...). Horizontal axis is $\langle\Tr\Sigma^2\rangle$ in lattice regularization. (a) and (b) were obtained with multicanonical weighting. In Ref.~\cite{Kajantie:1997tt} they give the histograms in Fig~4 in terms of the continuum condensate $\langle \frac{A^a_0 A^a_0}{2g^2_3} \rangle$. Because the condensates in \MSbar and on the lattice are related by additative renormalization, the relation between \textit{differences} in our and their histograms is $\Delta\langle \frac{A^a_0 A^a_0}{2g^2_3} \rangle_\text{Kari} = \frac{\beta_G}{4}\Delta\langle \Tr\Sigma^2\rangle_\text{latt}$. It is straightforward to check that the separation of the pure phases in our histograms matches what they have. \lauri{Note that (c) does NOT give the same relative probabilities as in Ref.~\cite{Kajantie:1997tt}. A possible explanation is that since their fit for $y_c(x)$ is performed at $V \rightarrow \infty$ limit, my value for the mass parameter may be slightly off here.}} 
	\label{fig:A0_only}
\end{figure}


\subsection{Comparing to Kari's simulations in Higgs + $A_0$ theory}

We can compare the full fundamental + adjoint case to the histograms in Fig.~23 of Ref.~\cite{Kajantie:1995kf}, with $\Sigma$ again being the $A_0$ field. Our DR suggests that the parameters need to be fixed (in terms of 4d parameters) as 
\begin{align}
\mu^2_\Sigma =& m^2_D = g_4^2 T^2 \left( \frac{5}{6} + \frac{N_f}{3} \right) , \quad b_4 = T \frac{g_4^4}{16\pi^2} \left( \frac{17+N_f}{3} \right), \nonumber \\
\quad a_2 =& 2 h_3 = \frac12 g^2_4 T \Big[ 1 + \frac{1}{16\pi^2} \Big( \frac{17}{2} - 4 (4 \ln 2 -1 ) \Big)g_4^2 - 6 y_t^2 + 12\lambda_4 \Big]
\end{align}
These follow simply from 1-loop DR in the SM. However, this is not quite what they use in Ref.~\cite{Kajantie:1995kf}, instead they have made some approximations.

Converting their action to our notation, we see that their $a_2$-term reads 
\begin{align}
\sum_{\textbf{x}} \frac14 a g^2 (a A^a_0 A^a_0) (a \phi^\dagger\phi),
\end{align}
i.e. they fix $h_3 = \frac12 a_2 = \frac14 g_3^2$, which is just the leading-order result from DR.

Performing a similar conversion for the $b_4$ term, we find that their quartic coupling is
\begin{align*}
\beta^A_4 = 4 \frac{b_4}{g^4_3 a},
\end{align*}
and judging from Ref.~\cite{Farakos:1994kx} it seems that they fix 
\begin{align}
b_4 \equiv \lambda_A = \frac{17 g_4^4 T}{48\pi^2},
\end{align}
i.e. they ignore the fermionic contribution from DR. Similarly their mass in the continuum seems to be simply 
\begin{align}
m^2_D = \frac56 g^2_4 T^2. 
\end{align}
\textbf{Note that all parameters in the $A_0$ sector are quite small, and the doublet will dominate the simulations.} Nevertheless, to my knowledge there are no other simulations in the literature performed with both Higgs and an adjoint scalar.

Now for some complications: in Ref.~\cite{Kajantie:1995kf} they do not actually list the explicit input parameters for the $A_0$ simulations. They give values for $m^*_H$ and $T^*$, but only give the relations to $x,y$ in terms of these \textbf{in the case of a fundamental Higgs only}, i.e. the relations already include the integration over $A_0$. So we would need to figure out what they used for $x,y$... 

Instead, I asked Kari to search through his old files and he found the following inputs for the fundamental + adjoint case:
\begin{align}
\beta_G = 12, \quad \beta_R = 0.00124, \quad \beta^A_2 = 1.136, \quad \beta^A_4 = 0.1914, 
\end{align}
with only $\beta_H$ varying. According to Ref.~\cite{Kajantie:1995kf} the $A_0$ histograms there are evaluated at $\beta_H = 0.34771$. In terms of these, a straightforward conversion to our lattice parameters gives: 
\begin{align}
m^2_\phi &= 2\left( \frac{1}{\beta_H} - 3 - \frac{2\beta_R}{\beta_H}\right) = -0.262345\\
\lambda &= \frac{4\beta_R}{\beta_H^2} = 0.0410249 \\
m^2_\Sigma &= -\frac{2\beta_2^A}{\beta_G} = -0.189333 \\
b_4 &= \frac{4\beta_4^A}{\beta_G^2} = 0.00531667 \\
a_2 &= \frac{2}{\beta_G} = \frac16 = 0.16666667.
\end{align}
Running simulations with these, we obtain histograms shown in Fig~\ref{fig:hgrams_SM_A0}. We see that although the small-volume histograms agree quite well with Kari, the histograms for $32^3$ and $40^3$ lattices \textbf{do not agree}. I am tempted to think that this is because the inputs are off (since I have no means of really verifying what they used). Note that it looks like the temperature is just slightly off here (insufficient numerical accuracy in the inputs??).

Some possible explanations for the discrepancy: 
\begin{itemize}

	\item Kari's original simulations with $A_0$ are based on their older paper, Ref.~\cite{Farakos:1994kj}. It is possible that their lattice-continuum relations used in these runs are not complete (at some point they only had 1-loop counterterms). However I took the inputs directly in Kari's lattice parametrization, so this does not explain why I get different histograms, assuming that my inputs really correspond to what Kari used. 

	\item Thermalization seems to occur quite slowly especially in the large-volume runs, so perhaps Kari had worse statistics? 

	\item Kari ran these simulations with his old Fortran code, could it have a bug in it? Kari mumbled something about using a wrong heatbath update in one of his early papers...

\end{itemize}
In any case, Kari did not seem  too worried about this discrepancy, especially since the small-volume histograms agree well. 


\begin{figure}[H]
	\includegraphics[scale=0.5]{hgrams_SM+A0}
	\caption{Histograms for $\gr{SU(2)}$ + Higgs + $A_0$ field, with inputs as given in the text. All of these were done without multicanonical weight, because the suppression was always quite small. It's easy to check that the condensate discontinuity agrees with that of Ref.~\cite{Kajantie:1995kf} (after conversion). \lauri{However, the large-volume histograms do not agree!! Wrong inputs?}}
\label{fig:hgrams_SM_A0}
\end{figure}


\section{Measuring physical stuff}

\subsection{Reweighting}

Suppose the action depends on some variable $x$, and consider a canonical probability distribution of some quantity $O$ evaluated at fixed $x$: 
\begin{align}
p_x(O) \propto e^{-S(x)}.
\end{align}
Suppose we then want to study the system with a slightly different value $x'$. Expanding $S$ around this point we have
\begin{align}
S(x) = S(x') + \frac{dS}{dx}\Big\vert_{x=x'} (x-x') + \mathcal{O(x-x')^2},
\end{align}
and in practice we can often approximate the derivative to be constant, at least if the values of $x$ are not very far from each other: $\frac{dS}{dx}\Big\vert_{x=x'} (x-x') \equiv k = \text{const}$. 

Then 
\begin{align}
p_{x}(O) \propto e^{-S(x')} e^{-k(x-x')} = C p_{x'}(O) e^{-k(x-x')}.
\end{align}
The expectation value is
\begin{align}
\langle O \rangle_x = \frac{1}{Z_x} \int D\phi \; O p_{x}(O) = \frac{Z_{x'}}{Z_x}C \langle O e^{-k(x-x')} \rangle_{x'},
\end{align}
and taking $O=1$ fixes the proportionality constant to be  
\begin{align}
\frac{Z_{x'}}{Z_x}C = \frac{1}{\langle e^{-k(x-x')}\rangle }_{x'}.
\end{align}
So we have the reweighting formula: If a canonical expectation value is known at value $x'$, at some other value $x$ the expectation value can be obtained from
\begin{align}
\langle O \rangle_x =  \frac{\langle O e^{-k(x-x')} \rangle_{x'}}{\langle e^{-k(x-x')}\rangle_{x'}}
\end{align}
provided that $x$ is not too far from the original $x'$. In Monte Carlo, 
\begin{align}
\langle O \rangle_x = \frac{1}{Z_x} \sum_{\{\phi\}} \; O(\phi) e^{-S} \approx \frac{1}{N_\text{meas}} \sum_{i=1}^{N_\text{meas}} O_i,
\end{align}
where we sum over measurements on the right-hand side. Hence the reweighting formula becomes
\begin{align}
\langle O \rangle_x \approx \frac{\sum_i O_i e^{-(x -x')k_i}}{\sum_i e^{-(x -x')k_i}}.
\end{align}

\paragraph{Reweighting with respect to the temperature.}

Now 
\begin{align}
\langle O \rangle_T \approx \frac{\sum_i O_i e^{-(T -T')k_i}}{\sum_i e^{-(T -T')k_i}}.
\end{align}
and on the lattice 
\begin{align}
k = \frac{dS}{dT} = \sum_x \frac{d}{dT} \left( m^2 \frac12 \Tr\Phi^\dagger\Phi + \dots \right) =  \sum_x \left( \frac{dm^2}{dT} \frac12 \Tr\Phi^\dagger\Phi + \dots \right).
\end{align}
Why does the derivative not act on the fields, even though our lattice field is clearly scaled by $T$ to make it dimensionless? The reason is that the fields are just integration variables in the path integral, which should anyway be evaluated at a fixed temperature. The scaling of fields affects the couplings, and this effect is captured in the above expression (\lauri{I haven't come up with a better argument...}). 

Now in a simulation we measure volume averages such as 
\begin{align}
\left\langle \frac12 \Tr\Phi^\dagger\Phi \right\rangle_i = \frac{1}{N} \sum_x \frac12 (\Tr\Phi^\dagger\Phi)_i.
\end{align}
Here the index $i$ refers to a fixed configuration (or measurement) and $N$ is the number of lattice sites, so that the physical volume is $V=a^3N$. The "reweighting factor" $k_i$ can therefore be written in terms of observables as 
\begin{align}
k_i = N \left( \frac{dm^2}{dT} \left\langle \frac12 \Tr\Phi^\dagger\Phi  \right\rangle_i + \dots \right). 
\end{align}
So to summarize, temperature reweighting can be once the $T$ dependence of all couplings appearing in the (lattice) action is known and volume averages of all operators in the action are measured. In practice, the derivatives can be evaluated at the original temperature $T'$ and approximated as constants. 

Note that in statistical mechanics, the canonical probability weight is $e^{-\beta E} = e^{-E/T}$, so reweighting with respect to $T$ would be performed using the energy. In our case the energy would be (from standard statistical physics) 
\begin{align}
E = T^2 \frac{\partial \ln Z}{\partial T} = -\frac{T^2}{Z} \int D\phi\; e^{-S} \frac{\partial S}{\partial T} = -T^2 \left\langle \frac{\partial S}{\partial T} \right\rangle.
\end{align}
In terms of Monte Carlo measurements:
\begin{align}
E = -T^2 \frac{1}{N_\text{meas}} \sum_i^{N_\text{meas}}\frac{\partial S_i}{\partial T},
\end{align}
which is not terribly useful because in reweighting, we need the energy at each measurement (but can be used for determining latent heat).

\subsection{Latent heat}

Latent heat is defined as the change in energy density across a phase transition. I can come up with two ways of measuring it from simulations (that hopefully should agree). 

\paragraph{Option 1.} As discussed above, the total energy for our system is given by 
\begin{align}
E = -T^2 \left\langle \frac{\partial S}{\partial T} \right\rangle,
\end{align}
which is now an average over Monte Carlo measurements. On the other hand, 
\begin{align}
\frac{\partial S_i}{\partial T} = N \left( \frac{dm^2}{dT} \left\langle \frac12 \Tr\Phi^\dagger\Phi  \right\rangle_i + \dots \right)
\end{align}
is constructed from volume averages of local operators (which is what we measure). Note that this is the same quantity that we use for reweighting. 

Now, it of course makes no sense to average over all configurations when looking for energy discontinuities. Instead we want to find the energies of the bulk phases and subtract them, so we should look at the histogram of $\partial S_i / \partial T$. Recipe for finding the latent heat is then to calculate the condensates of relevant operators in the bulk phases (histogram peaks), and take the difference. So the latent heat over $T^4$ (to make it dimensionless) is 
\begin{align}
\frac{L}{T^4} =& \frac{1}{T^4} \Delta\frac{E}{V} = -\frac{T^2}{T^4 a^3 N} \Delta \left\langle\frac{\partial S}{\partial T}\right\rangle \nonumber \\
=& -\frac{1}{T^2 a^3 N} \Delta \underbrace{N \left( \frac{dm^2}{dT} \left\langle \frac12 \Tr\Phi^\dagger\Phi  \right\rangle + \dots \right)}_{\text{"reweight string"}},
\end{align}
where $\Delta \langle \dots \rangle = \langle \dots \rangle_\text{low-$T$ phase} - \langle \dots \rangle_\text{high-$T$ phase}$.

\begin{comment}
Latent heat is defined as the change in energy density across a phase transition. It can be calculated directly from the 3d action as follows. Our partition function is
\begin{align}
Z = \int D\phi \; e^{-\beta S_3}, 
\end{align}
while in statistical mechanics it is customary to write the exponential in terms of the energy as $e^{-\beta E}$. So we have the clear analogue $E = S_3$, but remember that often the prefactor $\beta = 1/T$ is included in our action. 

\paragraph{Option 1.} In lattice discretization the exponential is $e^{-S_L}$ with
\begin{align*}
S_L =& \sum_x a^3 \mathcal{L}_\text{L} = \sum_x \left( m^2_L \frac12 \Tr\Phi^\dagger\Phi + \lambda_L \left(\frac12 \Tr\Phi^\dagger\Phi\right)^2 + \dots \right) = \frac{E}{T}. 
\end{align*}
In simulations we measure volume averages such as 
\begin{align*}
\left\langle \frac12 \Tr\Phi^\dagger\Phi \right\rangle = \frac{1}{N} \sum_x \frac12 \Tr\Phi(x)^\dagger\Phi(x),
\end{align*}
where $N$ is the number of lattice sites, so the physical volume is $V = a^3 N$. With some abuse of notation, we can then write the energy in terms of these volume averages as 
\begin{align*}
\frac{E}{T} = N \left( m^2_L \left\langle\frac12 \Tr\Phi^\dagger\Phi\right\rangle + \lambda_L \left\langle\left(\frac12 \Tr\Phi^\dagger\Phi\right)^2\right\rangle + \dots \right) = N \langle S_L \rangle.
\end{align*}
Since $S_L$ approaches the continuum action as $a\rightarrow 0$, it is justified to measure the energy directly from the lattice action. 

The latent heat can then be calculated from condensate discontinuities as 
\begin{align*}
L = \Delta \left(\frac{E}{V}\right) = \frac{T N}{a^3 N} \Delta\langle{S_L}\rangle = \frac{T}{a^3} \left( m^2_L \Delta \left\langle\frac12 \Tr\Phi^\dagger\Phi\right\rangle + \lambda_L \Delta \left\langle\left(\frac12 \Tr\Phi^\dagger\Phi\right)^2\right\rangle + \dots \right).
\end{align*}
Here $\Delta \langle \dots \rangle = \langle \dots \rangle_\text{low-$T$ phase} - \langle \dots \rangle_\text{high-$T$ phase}$, and local condensates of all (discontinuous) operators appearing in the action should be included (and obviously $T$ fixed to the transition temperature). Note that often the dimensionless $L / T^4$ is considered instead.

\paragraph{Option 2.} Starting from the statistical definition of $E$:
\begin{align*}
E = T^2 \frac{\partial \ln Z}{\partial T} = -T^2 \frac{1}{Z} \int D\phi\; \frac{\partial S}{\partial T} e^{-S} = -T^2 \left\langle \frac{\partial S}{\partial T} \right\rangle
\end{align*}

\end{comment}

\subsection{Finding the critical temperature without sampling pure phases}

For strong transitions with strongly metastable phases (especially 2-steps) it can be difficult to find a good starting temperature for multicanonical sampling. This is because it is then practically impossible to get the system to tunnel even once near $T_c$, and tunneling may occur only at temperatures much lower than the critical temperature. In this case it is convenient to use the following method, which only samples mixed-phase configurations.

The recipe is as follows:
\begin{enumerate}
	\item Use a long lattice, $n_z \gg n_x, n_y$, and prepare the system in a mixed configuration where sites with $z < n_z/2$ are in phase 1 and sites with $z > n_z/2$ are in phase 2. 
	
	\item For a suitable order parameter (\textit{e.g.} $\langle\phi^\dagger\phi - \Tr\Sigma^2\rangle$), use a multicanonical weight to constrain the system to a very narrow range around the starting value. In practice, choose the order parameter so that it starts with value 0, then set zero weight in, for example, range $(-0.1, 0.1)$ and infinite ($=$absurdly large) weight elsewhere (keep the weight constant during the simulation!). This corresponds to sampling the mixed-phase configurations only, because the weight prevents the system from evolving into a pure phase. On a long lattice, the phase boundaries (2 on a periodic lattice) stay perpendicular to the $z$-axis, and at critical temperature both phases should occupy half of the lattice.
	
	\item Look at the histogram of the order parameter in the range of interest, and find the temperature where the histogram is flat. Easily done by reweighting.
	
\end{enumerate}
Once the $T_c$ is known, latent heat can be found simply by preparing the system in a pure phase and finding the expectation values of condensates there, and then repeating for the other phase. Getting the surface tension without actually studying tunneling is less straightforward, but Kari had some trick in mind for this too.

Some practical notes:
\begin{itemize}
	\item If the system manages to escape outside the weighting range, there is nothing stopping it from getting stuck in a pure phase. Lesson: either use steep linear weight a la Kari that forces the system to "roll" back near the initial value if it attempts to escape, or just make sure that the "infinite" weight really is practically infinite.

	\item For thermalization, it (probably) helps to allow for small initial fluctuations when setting up the wall. However, in this case it's better to use a "linearly infinite" weight function (like Kari did) because the initial order parameter is now slightly random.

	\item If the temperature is far from $T_c$, it is not rare to find the system occupying only one end of the weight range.
	
\end{itemize}


\appendix 

\section{Lattice-continuum relations}
\label{sec:lat-cont}

Due to renormalization scheme dependence, the relation between continuum and lattice parameter is nontrivial. In a superrenormalizable 3d theory, \MSbar masses run at two loops while dimensionless couplings are RG invariant. Furthermore, the condensates such as $\langle \phi^\dagger\phi \rangle$ are scheme dependent and need to be matched, although their renormalization is additive and does not affect differences (which are sufficient for extracting the physics). In practice the condensates can be matched by calculating the unphysical zero-point divergence of the effective potential. The schemes can be matched exactly (in the continuum limit!) at two loop level, so that the lattice-continuum relations do not obtain further corrections at higher orders. This has been done in Refs.~\cite{Laine:1995np, Laine:1997dy} for the SM and some extensions. Here we collect the results relevant for our cases. I have carefully checked that the expressions below match those of both references \cite{Laine:1995np, Laine:1997dy} where comparison is possible.

Denoting $m_i = \text{lattice mass}, \mu_i = \text{\MSbar mass}$, the two are related as 
\begin{align}
m^2_i = a^2 (\mu^2_i(\Lambda) + \delta m^2_i(\hbar) + \delta m^2_i(\hbar^2) ),
\end{align}
where $\hbar$ is the loop counting parameter. Constants often appearing in the counterterms read \cite{Laine:1997dy}: 
\begin{align}
\Sigma \approx& 3.17591153625, \quad \zeta \approx 0.08849, \quad \delta \approx 1.942130, \quad \rho \approx -0.313964, \nonumber \\ 
\quad \kappa_1 \approx& 0.958382, \quad \kappa_2 = \frac{\Sigma^2}{4} - \frac{\delta}{2} - \frac14, \quad \kappa_3 \approx 0.751498, \quad \kappa_4 \approx 1.204295.
\end{align}
We will denote the \MSbar scale in 3d by $\Lambda$ and the 3d parameters are assumed to be in natural 3d units (e.g. $g^2$ has dimension GeV).

\subsection{$\gr{SU(2)}$ + fundamental Higgs}

The relation between lattice and continuum Higgs condensates is \lauri{(bad notation; here $m^2_\phi$ means mass in lattice regularization, with units GeV$^2$)}
\begin{align}
\langle \frac12\Tr\he\Phi\Phi\rangle_\text{cont} = \langle\phi^\dagger\phi\rangle_\text{cont} = a^{-1}\langle \frac12\Tr\he\Phi\Phi\rangle_\text{latt} + \frac{d(\delta V)}{dm^2_\phi}, 
\end{align}
where 
\begin{align}
\label{eq:vacuumCT_higgs}
\delta V =& - 2 m^2_\phi \frac{\Sigma}{4\pi a} - \frac{3}{16\pi^2} g^2 m^2_\phi \Big( \ln \frac{6}{a \Lambda} +\zeta + \frac{\Sigma^2}{4} - \delta \Big).
\end{align}

The full mass counterterm is
\begin{align}
(\delta m^2_\phi)_\text{fund} =& -\Big(\frac32 g^2 + 6\lambda\Big) \frac{\Sigma}{4\pi a} \nonumber \\
&- \frac{1}{16\pi^2}\Big[ \Big( \frac{51}{16}g^4 + 9\lambda g^2 - 12\lambda^2 \Big)\Big( \ln \frac{6}{a\Lambda}+\zeta \Big)
 + 9\lambda g^2 \Big( \frac14 \Sigma^2 - \delta \Big) \nonumber \\ 
& + \frac34 g^4 \Big( \frac{15}{16}\Sigma^2 + \frac{\pi}{3} \Sigma + \frac54 - \frac72 \delta - 4\rho +4\kappa_1 - \kappa_2 - \kappa_3 - 3\kappa_4  \Big) \Big].
\end{align}


If the hypercharge field is included, the counterterms are instead 
\begin{align}
\delta V_{\gr{U(1)}} =& - 2 m^2_\phi \frac{\Sigma}{4\pi a} - \frac{1}{16\pi^2} (3g^2 + {g'}^2) m^2_\phi \Big( \ln \frac{6}{a \Lambda} +\zeta + \frac{\Sigma^2}{4} - \delta \Big),
\end{align}
\begin{align}
(\delta m^2_\phi)_{\text{fund}, \gr{U(1)}} =& -\Big(\frac32 g^2 + \frac12 {g'}^2 + 6\lambda\Big) \frac{\Sigma}{4\pi a} \nonumber \\
&- \frac{1}{16\pi^2}\Big[ \Big( \frac{51}{16}g^4 - \frac98 g^2 {g'}^2 - \frac{5}{16} {g'}^4 + 9\lambda g^2 + 3\lambda {g'}^2 - 12\lambda^2 \Big)\Big( \ln \frac{6}{a\Lambda}+\zeta \Big) \nonumber \\ 
& + 3\lambda(3g^2 + {g'}^2)  \Big( \frac14 \Sigma^2 - \delta \Big) + \lauri{A {g'}^4 + B g^2 {g'}^2 }\nonumber \\
& + \frac34 g^4 \Big( \frac{15}{16}\Sigma^2 + \frac{\pi}{3} \Sigma + \frac54 - \frac72 \delta - 4\rho +4\kappa_1 - \kappa_2 - \kappa_3 - 3\kappa_4  \Big) \Big].
\end{align}
These were taken from \cite{Kajantie:1996qd}, with some guessing based on similarity of $\gr{SU(2)}$ and $\gr{U(1)}$ Feynman diagrams. This was necessary because they only gave numerical values for terms on the last two rows. \lauri{I did not manage to figure out exact expressions for the coefficients $A$ and $B$!!}

\subsection{$\gr{SU(2)}$ + adjoint scalar}

The triplet condensate, we have:
\begin{align}
\frac12 \langle \Sigma^a\Sigma^a\rangle_\text{cont} = \langle\Tr \Sigma^2\rangle_\text{cont} = a^{-1} \langle \Tr \Sigma^2 \rangle_\text{latt} + \frac{d(\delta V)}{dm^2_\Sigma},
\end{align}
where the counterterm is the sum of
\begin{align}
\label{eq:vacuumCT_adj}
\delta V(\hbar) =& -\frac32 m^2_\Sigma \frac{\Sigma}{4\pi a} \nonumber \\
\delta V(\hbar^2) =& -\frac{1}{16\pi^2} 6g^2 m^2_\Sigma \Big( \ln \frac{6}{a \Lambda} +\zeta + \frac{\Sigma^2}{4} - \delta\Big).
\end{align}

The mass counterterm is the sum of
\begin{align}
(\delta m^2_\Sigma(\hbar))_\text{adj} =& -(4g^2 + 5 b_4) \frac{\Sigma}{4\pi a}, \\
(\delta m^2_\Sigma(\hbar^2))_\text{adj} =& -\frac{1}{16\pi^2} \Big[ \Big( 20 b_4 g^2 - 10 b^2_4 \Big)\Big( \ln\frac{6}{a \Lambda} + \zeta \Big) +20 b_4 g^2 \Big( \frac14 \Sigma^2 - \delta \Big) \nonumber \\
 &+ 2 g^4 \Big( \frac54 \Sigma^2 + \frac{\pi}{3}\Sigma - 6\delta -6\rho + 4\kappa_1 -\kappa_2 - \kappa_3 - 3\kappa_4 \Big) \Big].
\end{align}
Note that Ref.~\cite{Laine:1995np} writes the adjoint as $A_0 = A^a_0 \sigma_a$, so their covariant derivative term has different factors of $2$ than we do. Overall the actions are still equivalent. Their parameters are simply $m_D = m_\Sigma, \lambda_A = b_4$.


\subsection{$\gr{SU(2)}$ + fundamental Higgs + adjoint scalar}

The vacuum divergence is not modified by the $a_2$ term, so the counterterm relating the condensates is simply the sum of Eqs.~(\ref{eq:vacuumCT_higgs}) and (\ref{eq:vacuumCT_adj}):
\begin{align}
\delta V =& - ( 2 m^2_\phi + \frac32 m^2_\Sigma ) \frac{\Sigma}{4\pi a} - \frac{3}{16\pi^2} g^2 ( m^2_\phi + 2 m^2_\Sigma ) \Big( \ln \frac{6}{a \Lambda} +\zeta + \frac{\Sigma^2}{4} - \delta \Big).
\end{align}

For the masses, we have 
\begin{align}
m^2_\phi =& a^2(\mu^2_\phi(\Lambda) + (\delta m^2_\phi)_\text{fund}+ (\delta m^2_\phi)_\text{both} )\\
m^2_\Sigma =& a^2( \mu^2_\Sigma(\Lambda) + (\delta m^2_\Sigma)_\text{adj} + (\delta m^2_\Sigma)_\text{both} ) 
\end{align}
where the new contributions read
\begin{align}
(\delta m^2_\phi)_\text{both} =& -\frac32 a_2 \frac{\Sigma}{4\pi a} - \frac{1}{16\pi^2} \Big[ \Big( -\frac34 g^4 + 6 a_2 g^2 - \frac32 a_2^2  \Big)\Big( \ln \frac{6}{a\Lambda}+\zeta \Big) \nonumber \\ 
& + 6 a_2 g^2 \Big( \frac14 \Sigma^2 - \delta \Big) - 3g^4 \rho \Big], \\
%
(\delta m^2_\Sigma)_\text{both} =& -2 a_2 \frac{\Sigma}{4\pi a} - \frac{1}{16\pi^2}\Big[ \Big( -g^4 + 3 a_2 g^2 - 2 a_2^2 \Big)\Big( \ln\frac{6}{a \Lambda} + \zeta \Big) \nonumber \\
&+ 3 a_2 g^2 \Big( \frac14 \Sigma^2 - \delta \Big) - 4 g^4 \rho \Big].
\end{align}
Note that there are also contributions not proportional to $a_2$.


\lauri{TODO $\gr{U(1)}$ parts!!}


\subsection{$\gr{SU(2)}$ + fundamental Higgs + singlet scalar}

Add the following terms to the $\gr{SU(2)}$ + Higgs action:
\begin{align}
S_S =& a \sum_{x,i} \left[ S^2 - S(x) S(x+i)\right] \nonumber \\
&+ a^3 \sum_x \Big[ b_1 S + \frac12 m^2_S S^2 + \frac13 b_3 S^3 + \frac14 b_4 S^4 + \frac12 a_1 S \frac12 \Tr \he\Phi\Phi + \frac12 a_2 S^2 \frac12 \Tr \he\Phi\Phi \Big].  
\end{align}
Here $m^2_S = m^2_S(\mu) + \delta m_S^2, b_1 = b_1(\mu) + \delta b_1$ etc with $\mu$ being the \MSbar scale.

Neglecting $\mathcal{O}(a)$, the counterterms are:
\begin{align}
\delta V =& -\hbar \frac{\Sigma}{4\pi a} \left( \frac12 m_S^2 + 2 m_\phi^2 \right) + \frac{1}{(4\pi)^2} \frac34 g^2 m_\phi^2 \Big[ (4\delta - \Sigma^2) - \Big( \ln\frac{6}{a\mu} + \zeta \Big) \Big] + \text{indep of masses and } b_1 \\
%% 
\nonumber\\
%%
\delta b_1 =& -\hbar \frac{\Sigma}{4\pi a}\left(b_3  + a_1\right) + \hbar^2 \frac{1}{(4\pi)^2} \Big[ \frac38 a_1 g^2 (4\delta - \Sigma^2) + \Big( 2 b_3 b_4 + a_1(a_2 - \frac32 g^2) \Big) \Big( \ln\frac{6}{a\mu} + \zeta \Big) \Big] \\
%% 
\nonumber\\
%%
\delta m^2_S =& -\hbar \frac{\Sigma}{4\pi a} (2a_2 + 3b_4) + \hbar^2 \frac{1}{(4\pi)^2} \Big[ \frac34 a_2 g^2 (4\delta - \Sigma^2) + \Big( 2a_2^2 + 6b_4^2 - 3a_2 g^2 \Big)\Big( \ln\frac{6}{a\mu} + \zeta \Big) \Big] \\
%% 
\nonumber\\
%%
\delta m^2_\phi =& -\hbar \frac{\Sigma}{4\pi a}\left( \frac12 a_2 + \frac32 g^2 + 6\lambda \right) + \hbar^2 \frac{1}{(4\pi)^2} \Big[ \Big( -\frac{51}{16}g^4 - 9g^2\lambda +12\lambda^2 + \frac12 a_2^2 \Big)\Big( \ln\frac{6}{a\mu} + \zeta \Big)  \nonumber \\
% 
& + 9 g^2 \lambda \left(\delta - \frac14 \Sigma^2 \right) - \frac34 g^2 \left( \frac{15}{16} \Sigma^2  + \frac{\pi}{3}\Sigma + \frac54 - \frac{11}{2}\delta - 6\rho + 4\kappa_1 - 2\kappa_4 \right)\Big]  .
\end{align}


\section{Code technicalities}

\begin{itemize}
	
	\item Dimensions of spacetime and the lattice size are not fixed beforehand; they are to be read in from config. Our lattice is a $L_1 \times L_2 \times \dots \times L_n$ sized periodic hypercube. It is recommended to use even numbers for $L_i$; otherwise checkerboard updating is not well defined. 
	
	\item We use a single index $i$ to label lattice sites and use this index to access field values etc, instead of Cartesian $(x, y, z, \dots)$ coordinates (these are used in initial layouting). In short, sites are ordered so that the site at origin $(0, 0, 0, \dots)$ has $i = 0$ ("upper left corner"), next site in positive direction $1$ has $i = 1$ etc. When we reach last site in direction $1$, we move one step in direction $2$ and repeat, and so on. Neighbor sites are stored in lookup tables before starting the simulation. \textbf{Update 23.8.2019:} Added routines in layout.c to further reorder the sites by parity. This allows for more optimized update sweeps (in quick test runs the improvement was $20\%$!). The full ordering using this option is: 1. even sites 2. odd sites 3. even halos 4. odd halos. To do: check if memory configuration could be optimized as well with parity ordering.
	
	\item Fields are dynamic arrays of doubles (double*, double**, double***) that are accessed as field[site index][direction][component] for gauge links, field[site index][component] for non-gauge fields. Gauge singlets are simply field[site]. Memory for fields is allocated contiguously. 
	
	\item OpenMPI is used for parallelization. The lattice is split into hypercubes of equal sizes with side lengths $L^\text{slice}_i$, and these are then laid out based on their MPI ranks with same indexing logic as for lattice sites. We treat each node as being a hypercube with side lengths $L^\text{slice}_i + 2$, where the two extra sites are halos that need to be updated using MPI communications. Halo site indexes come after real sites, but otherwise follow same ordering logic. Due to periodicity, it can happen that the physical site corresponding to a halo is actually a real site in the same node. These "self halos" are removed by simply changing the neighbor lookup table to point to the real site instead. All this is implemented in layout.c. 
	
	\item Communication between nodes is implemented in comms.c. We use a "comlist" structure to store information of what site indices our node is supposed to send to which nodes, and what halo site indices do we update with data received from them. Send/receive data is copied into temporary buffers each time we update halos. Each update, we first send our data to all neighbors using nonblocking sends, then proceed with blocking receives to update our halos, and finally wait for all of our sends to go through (usually done by the time we get to the wait loop). Variable c.comms\_time keeps track of the time spent on MPI communications (excluding global multicanonical checks).
	
	\item Updating the lattice is done with checkerboard style sweeps (imagine a chessboard). We specify parity of a site to be EVEN if $x + y + z + \dots $ is an even number, ODD otherwise. When sweeping, we first update all sites with EVEN parity, including halos, and then repeat for ODD sites. Gauge links are updated one direction at a time, because the directions are not independent (think of the Wilson plaquette).  
	
	\item \textbf{18.9.2019:} I have crosschecked carefully against David's code using the same seed for drand48(), and verified that our programs produce exactly the same numbers with $\gr{SU(2)}$ links, Higgs and real triplet all included in the simulation. By "same numbers" I mean that starting from the same initial configuration, fields change exactly the same way in all local updates in both programs, and consequently the measured values for all observables are exactly the same (some care was needed with precision, since David inputs $g$ instead of $\beta_G$). The comparison was done by arranging update routines in David's version so that everything happens in the same order as in my implementation. I used serial version of David's code and parallel version of my code (but with 1 MPI node) on a $32 \times 32 \times 32$ lattice. I performed separate tests on full Metropolis and scalar Metropolis + gauge heatbath, and both work (did not compare overrelaxation).

	
\end{itemize}


\begin{thebibliography}{*}


%\cite{Berg:1991cf}
\bibitem{Berg:1991cf}
  B.~A.~Berg and T.~Neuhaus,
  %``Multicanonical algorithms for first order phase transitions,''
  Phys.\ Lett.\ B {\bf 267} (1991) 249.
  doi:10.1016/0370-2693(91)91256-U
  %%CITATION = doi:10.1016/0370-2693(91)91256-U;%%
  %132 citations counted in INSPIRE as of 21 Aug 2019

%\cite{Laine:1998qk}
\bibitem{Laine:1998qk}
M.~Laine and K.~Rummukainen,
%``The MSSM electroweak phase transition on the lattice,''
Nucl.\ Phys.\ B {\bf 535} (1998) 423
doi:10.1016/S0550-3213(98)00530-6
[hep-lat/9804019].
%%CITATION = doi:10.1016/S0550-3213(98)00530-6;%%
%172 citations counted in INSPIRE as of 21 Aug 2019


%\cite{Kajantie:1995kf}
\bibitem{Kajantie:1995kf}
  K.~Kajantie, M.~Laine, K.~Rummukainen and M.~E.~Shaposhnikov,
  %``The Electroweak phase transition: A Nonperturbative analysis,''
  Nucl.\ Phys.\ B {\bf 466} (1996) 189
  doi:10.1016/0550-3213(96)00052-1
  [hep-lat/9510020].
  %%CITATION = doi:10.1016/0550-3213(96)00052-1;%%
  %363 citations counted in INSPIRE as of 24 Apr 2019
  
%\cite{Kajantie:1997tt}
\bibitem{Kajantie:1997tt}
  K.~Kajantie, M.~Laine, K.~Rummukainen and M.~E.~Shaposhnikov,
  %``3-D SU(N) + adjoint Higgs theory and finite temperature QCD,''
  Nucl.\ Phys.\ B {\bf 503} (1997) 357
  doi:10.1016/S0550-3213(97)00425-2
  [hep-ph/9704416].
  %%CITATION = doi:10.1016/S0550-3213(97)00425-2;%%
  %194 citations counted in INSPIRE as of 24 Apr 2019


%\cite{Kennedy:1985nu}
\bibitem{Kennedy:1985nu}
  A.~D.~Kennedy and B.~J.~Pendleton,
  %``Improved Heat Bath Method for Monte Carlo Calculations in Lattice Gauge Theories,''
  Phys.\ Lett.\  {\bf 156B} (1985) 393.
  doi:10.1016/0370-2693(85)91632-6
  %%CITATION = doi:10.1016/0370-2693(85)91632-6;%%
  %234 citations counted in INSPIRE as of 22 Aug 2019

  %\cite{Farakos:1994kx}
\bibitem{Farakos:1994kx}
  K.~Farakos, K.~Kajantie, K.~Rummukainen and M.~E.~Shaposhnikov,
  %``3-D physics and the electroweak phase transition: Perturbation theory,''
  Nucl.\ Phys.\ B {\bf 425} (1994) 67
  doi:10.1016/0550-3213(94)90173-2
  [hep-ph/9404201].
  %%CITATION = doi:10.1016/0550-3213(94)90173-2;%%
  %254 citations counted in INSPIRE as of 07 May 2019


%\cite{Laine:1995np}
\bibitem{Laine:1995np}
  M.~Laine,
  %``Exact relation of lattice and continuum parameters in three-dimensional SU(2) + Higgs theories,''
  Nucl.\ Phys.\ B {\bf 451} (1995) 484
  doi:10.1016/0550-3213(95)00356-W
  [hep-lat/9504001].
  %%CITATION = doi:10.1016/0550-3213(95)00356-W;%%
  %69 citations counted in INSPIRE as of 24 Apr 2019

%\cite{Laine:1997dy}
\bibitem{Laine:1997dy}
  M.~Laine and A.~Rajantie,
  %``Lattice continuum relations for 3-D SU(N) + Higgs theories,''
  Nucl.\ Phys.\ B {\bf 513} (1998) 471
  doi:10.1016/S0550-3213(97)00709-8
  [hep-lat/9705003].
  %%CITATION = doi:10.1016/S0550-3213(97)00709-8;%%
  %67 citations counted in INSPIRE as of 12 Aug 2019


%\cite{Farakos:1994kj}
\bibitem{Farakos:1994kj}
  K.~Farakos, K.~Kajantie, K.~Rummukainen and M.~E.~Shaposhnikov,
  %``The Electroweak phase transition at m(H) approximately = m(W),''
  Phys.\ Lett.\ B {\bf 336} (1994) 494
  doi:10.1016/0370-2693(94)90563-0
  [hep-ph/9405234].
  %%CITATION = doi:10.1016/0370-2693(94)90563-0;%%
  %82 citations counted in INSPIRE as of 19 Sep 2019

%\cite{Kajantie:1996qd}
\bibitem{Kajantie:1996qd}
  K.~Kajantie, M.~Laine, K.~Rummukainen and M.~E.~Shaposhnikov,
  %``A Nonperturbative analysis of the finite T phase transition in SU(2) x U(1) electroweak theory,''
  Nucl.\ Phys.\ B {\bf 493} (1997) 413
  doi:10.1016/S0550-3213(97)00164-8
  [hep-lat/9612006].
  %%CITATION = doi:10.1016/S0550-3213(97)00164-8;%%
  %168 citations counted in INSPIRE as of 20 Sep 2019


\end{thebibliography}

\end{document}
